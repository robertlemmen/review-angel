% this tex file uses an external script to transform some of the source before
% rendering, therefore it needs to be processed with the --shell-escape cmdline
% argument to pdflatex

\documentclass[10pt,twoside]{article}
\usepackage[paperwidth=5.5in,paperheight=8.5in]{geometry}
\usepackage{lmodern}
\usepackage[T1]{fontenc}
\usepackage[linkcolor=blue, colorlinks=true]{hyperref}
\usepackage[pdftex]{graphicx,color}
\usepackage{fancyhdr}
\usepackage{fancyvrb}
\usepackage{bashful}

% XXX debug stuff, remove later
\usepackage{lipsum}
\usepackage{layout}

% XXX what a terrible mix of units,
% XXX margins also probably need adjustments
\setlength{\hoffset}{-25pt}
\setlength{\voffset}{-25pt}
\setlength{\oddsidemargin}{12pt}
\setlength{\evensidemargin}{0pt}
\setlength{\topmargin}{0pt}
\setlength{\headheight}{0pt}
\setlength{\headsep}{0pt}
\setlength{\parindent}{0cm}
\setlength{\parskip}{.2cm}
\setlength{\tabcolsep}{.2cm}
\setlength{\textheight}{\paperheight}
\addtolength{\textheight}{-2in}
\addtolength{\textheight}{35pt}
\setlength{\textwidth}{\paperwidth}
\addtolength{\textwidth}{-2in}
\addtolength{\textwidth}{38pt}

% XXX where exactly should the page numbers be? 
\pagestyle{fancy}
\fancyhead{}
\fancyhf{}
\fancyfoot[LE,RO]{\qquad\thepage}
\fancyfoot[RO]{\thepage\qquad}
\renewcommand{\headrulewidth}{0pt}
\setlength{\footskip}{32pt}

\newenvironment{review-request}
  {\VerbatimOut{rr.temp}}
  {\endVerbatimOut
\immediate\write18{cat rr.temp | ./rr-proc > rr2.temp}
\fbox{\begin{minipage}{\dimexpr\textwidth-8pt\relax}
\small
\input{rr2.temp}
\end{minipage}}
\vskip .8em
}

\newcommand{\pppline}[1]{\ttfamily\fontseries{m}\selectfont #1\par}
\newcommand{\pline}[1]{\ttfamily\fontseries{b}\selectfont #1\par}
\newcommand{\oline}[1]{\ttfamily\fontseries{l}\selectfont #1\par}

\pdfinfo {
    /Title(Review Angel)
    /Author(Robert Lemmen)
}

\begin{document}

\begin{titlepage}
\begin{center}~\\
\vspace{3em}
{\fontsize{36}{36}\fontencoding{T1}\fontfamily{lmss}\fontseries{m}\selectfont
REVIEW ANGEL}\\
\vspace{36pt}
{\large Robert Lemmen}
\vfill
\includegraphics[width=\textwidth]{logo}
\vfill
% XXX better subtitle
{\large As if shit mattered}
\vspace{3em}
\end{center}
\end{titlepage}
\thispagestyle{empty}
\clearpage

DRAFT -- \today

\vspace{1.5em}
\copyright~2019~--~2020 Robert Lemmen $<$robertle@semistable.com$>$

% XXX more motivational paragraph that people can contribute

\vspace{1.5em}
This book is open source licensed under the Artistic License 2.0\footnote{
https://opensource.org/licenses/Artistic-2.0}. Please report errors, provide
feedback and adapt to your needs in the github repository \footnote{
https://github.com/robertlemmen/review-angel}.
\thispagestyle{empty}
\clearpage

\tableofcontents
\clearpage

\section{Preface}
\section{Why We Review}

\begin{review-request}
diff --git a/interp.c b/interp.c
index a911046..f0a2a18 100644
--- a/interp.c 
+++ b/interp.c
@@ -129,6 +129,7 @@ void env_bind(struct allocator *alloc, struct interp_env *env, value symbol, val
         assert(value_is_symbol(ee->name)); 
         if (strcmp(value_to_symbol(&ee->name), value_to_symbol(&symbol)) == 0) {
             ee->value = val;
+            write_barrier(alloc, ee_v, &ee->value);
             return;
         }
         prev = ee;
\end{review-request}

\lipsum

\lipsum
\clearpage
\layout

\end{document}
